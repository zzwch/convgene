top_n(n_deg_top, -p_val_adj) %>%
top_n(n_deg_top, avg_logFC) %>%
ungroup() %>%
pf_deg_corrHeatmap(main = "hsa")
pf_deg_corrHeatmap <- function(degs, main = "Corr. Heatmap", ...){
require(pheatmap)
phres <- pf_deg_heatmap(degs, clustering_cols = T)
pheatmap(mat = degs %>% dplyr::select(brEC:lyEC) %>% cor,
cluster_rows = phres$tree_col, cluster_cols = phres$tree_col,
#clustering_distance_rows = "correlation", clustering_distance_cols = "correlation", clustering_method = "ward.D",
#clustering_distance_cols = "euclidean", clustering_method = "ward.D",
scale = "none", show_rownames = T,
color = colorRampPalette(c("blue2", "grey100", "red2"))(51),
main = main, ...)
}
# deg heirarchy
n_deg_top <- 100
hsa_degs %>% #filter(cluster != "ADAMTS5+ EC") %>%
group_by(cluster) %>%
top_n(n_deg_top, -p_val_adj) %>%
top_n(n_deg_top, avg_logFC) %>%
ungroup() %>%
pf_deg_corrHeatmap(main = "hsa")
mcc_degs %>% group_by(cluster) %>%
top_n(n_deg_top, -p_val_adj) %>%
top_n(n_deg_top, avg_logFC) %>%
ungroup() %>%
dplyr::select(brEC:lyEC) %>%
pf_deg_corrHeatmap(main = "mcc")
mmu_degs %>% group_by(cluster) %>%
top_n(n_deg_top, -p_val_adj) %>%
top_n(n_deg_top, avg_logFC) %>%
ungroup() %>%
dplyr::select(brEC:lyEC) %>%
pf_deg_corrHeatmap(main = "mmu")
# # pca
# hsa_degs %>% filter(cluster != "ADAMTS5+ EC") %>%
#   group_by(cluster) %>%
#   top_n(n_deg_top, -p_val_adj) %>%
#   top_n(n_deg_top, avg_logFC) %>%
#   ungroup() %>%
#   dplyr::select(brEC:lyEC) %>%
#   scale() %>%
#   prcomp() ->tmp
#
# tmp$rotation %>% as.data.frame %>% rownames_to_column() %>%
#   ggplot(mapping = aes(PC1, PC2)) +
#   geom_point(mapping = aes(color = rowname)) +
#   geom_text(mapping = aes(label = rowname))
#hsa_mnn %>% Embeddings(reduction = "mnn") %>%
#AverageHeatmap(hsa_mnn, markerGene = hsa_degs %>% filter(tf) %>% pull(gene) %>% unique, group.by = "Cluster", showRowNames = F, myanCol = color_cluster_hsa, annoCol = T, markGenes = c("FOXF1", "FOXQ1"))
#AverageHeatmap(hsa_mnn, markerGene = hsa_degs %>% filter(mb) %>% pull(gene) %>% unique, group.by = "Cluster", showRowNames = F, myanCol = color_cluster_hsa, annoCol = T, markGenes = c("FOXF1", "FOXQ1"), row_title = "Metabolism genes")
pf_deg_heatmap <- function(degs = NULL,main = "Heatmap", clustering_cols = F, ...){
data <- degs %>% dplyr::select(brEC:lyEC)
table(degs$cluster) -> geneNum
main_text <- str_c(str_glue("{names(geneNum)}={geneNum}"), collapse = ", ")
require(pheatmap)
pheatmap(mat = data,
cluster_rows = F, cluster_cols = clustering_cols,
clustering_distance_cols = "correlation", clustering_method = "ward.D",
#clustering_distance_cols = "euclidean", clustering_method = "ward.D",
scale = "row", show_rownames = F,
color = colorRampPalette(c("blue2", "grey100", "red2"))(51),
main = str_wrap(str_c(main, "\n", main_text), width = 20),
#fontsize = 5, fontsize_col = 8,
...)
}
hsa_degs %>% pf_deg_heatmap(main = "hsa") #filter(cluster != "ADAMTS5+ EC") %>%
mcc_degs %>% pf_deg_heatmap(main = "mcc")
mmu_degs %>% pf_deg_heatmap(main = "mmu")
pf_deg_corrHeatmap <- function(degs, main = "Corr. Heatmap", ...){
require(pheatmap)
phres <- pf_deg_heatmap(degs, clustering_cols = T)
pheatmap(mat = degs %>% dplyr::select(brEC:lyEC) %>% cor,
cluster_rows = phres$tree_col, cluster_cols = phres$tree_col,
#clustering_distance_rows = "correlation", clustering_distance_cols = "correlation", clustering_method = "ward.D",
#clustering_distance_cols = "euclidean", clustering_method = "ward.D",
scale = "none", show_rownames = T,
color = colorRampPalette(c("blue2", "grey100", "red2"))(51),
main = main, ...)
}
# deg heirarchy
n_deg_top <- 100
hsa_degs %>% #filter(cluster != "ADAMTS5+ EC") %>%
group_by(cluster) %>%
top_n(n_deg_top, -p_val_adj) %>%
top_n(n_deg_top, avg_logFC) %>%
ungroup() %>%
pf_deg_corrHeatmap(main = "hsa")
mcc_degs %>% group_by(cluster) %>%
top_n(n_deg_top, -p_val_adj) %>%
top_n(n_deg_top, avg_logFC) %>%
ungroup() %>%
dplyr::select(brEC:lyEC) %>%
pf_deg_corrHeatmap(main = "mcc")
mmu_degs %>% group_by(cluster) %>%
top_n(n_deg_top, -p_val_adj) %>%
top_n(n_deg_top, avg_logFC) %>%
ungroup() %>%
dplyr::select(brEC:lyEC) %>%
pf_deg_corrHeatmap(main = "mmu")
# # pca
# hsa_degs %>% filter(cluster != "ADAMTS5+ EC") %>%
#   group_by(cluster) %>%
#   top_n(n_deg_top, -p_val_adj) %>%
#   top_n(n_deg_top, avg_logFC) %>%
#   ungroup() %>%
#   dplyr::select(brEC:lyEC) %>%
#   scale() %>%
#   prcomp() ->tmp
#
# tmp$rotation %>% as.data.frame %>% rownames_to_column() %>%
#   ggplot(mapping = aes(PC1, PC2)) +
#   geom_point(mapping = aes(color = rowname)) +
#   geom_text(mapping = aes(label = rowname))
#hsa_mnn %>% Embeddings(reduction = "mnn") %>%
#AverageHeatmap(hsa_mnn, markerGene = hsa_degs %>% filter(tf) %>% pull(gene) %>% unique, group.by = "Cluster", showRowNames = F, myanCol = color_cluster_hsa, annoCol = T, markGenes = c("FOXF1", "FOXQ1"))
#AverageHeatmap(hsa_mnn, markerGene = hsa_degs %>% filter(mb) %>% pull(gene) %>% unique, group.by = "Cluster", showRowNames = F, myanCol = color_cluster_hsa, annoCol = T, markGenes = c("FOXF1", "FOXQ1"), row_title = "Metabolism genes")
# see DEG.Rmd
print(load("data/degs/go.degs_by_cluster.each_species.RData")) # hsa_deg is used
# [1] "hsa_deg_go"      "mcc_deg_go"      "mcc_deg_go_homo" "mmu_deg_go"
pf_go_cluster <- function(godata, title = "GO terms of DEGs"){
sapply(names(godata), function(x){
godata[[x]]@result %>% mutate(cluster = x)
}, simplify = F) %>% bind_rows() %>%
group_by(cluster) %>%
top_n(5, -pvalue) %>%
top_n(5, -p.adjust) %>%
mutate(x = -log10(pvalue),
cluster = factor(cluster, levels = unique(.$cluster)),
y = fct_cross(Description %>% fct_inorder() %>% fct_rev(), cluster)) %>%
ungroup() -> ggData
ggData %>%
ggplot(mapping = aes(x, y, group = cluster)) +
geom_bar(mapping = aes(fill = cluster),
stat = "identity", width = 0.8, show.legend = F) +
geom_text(mapping = aes(label = Description), x = 0.1, hjust = 0, vjust = 0.2, size = 3
) +
facet_grid(cluster~., scales = "free", space = "free") +
scale_fill_manual(values = color_cluster[levels(ggData$cluster)]) +
scale_x_continuous(expand = expansion(c(0,0.05))) +
theme(axis.text.y = element_blank(),
axis.ticks.y = element_blank(), panel.spacing = unit(2, "pt"),
axis.text.x = element_text(angle = 0, hjust = 0.5)) +
labs(x = "-log10(P value)", y = NULL, title = title)
}
#plot
hsa_deg_go %>% pf_go_cluster(title = "Human")
mcc_deg_go_homo %>% pf_go_cluster(title = "Macaque")
mmu_deg_go %>% pf_go_cluster(title = "Mouse")
get_deg_avg_zscore <- function(object, degs, group.by = fct_cross(object$Stage, object$Cluster), do.filter = T){
object$group <- group.by
groups_diff <- NULL
if(do.filter){
groups_diff %<>% c(names(which(table(group.by) < 5)))
if(object$Species[1] == "Macaque") groups_diff %<>% c(c("CS 20:adEC")) # these groups are not very robust, which is preferred to be excluded
if(object$Species[1] == "Human")  groups_diff %<>% c(c("week 8:spEC"))
}
object <- object[,!object$group %in% groups_diff]
pl_averageHeatmap(data = object %>% GetAssayData(),
features = degs$gene,
group_by = object$group,
scale_feature = T,
cap_max = Inf, cap_min = -Inf,
cluster_cols = F, show_rownames = F, return.avg = T) -> avg_data
rownames(avg_data) <- paste0(degs$cluster, "_", degs$gene)
return(avg_data)
}
hsa_degs_avgzscore <- hsa_mnn %>% get_deg_avg_zscore(hsa_degs)
mcc_degs_avgzscore <- mcc_mnn %>% get_deg_avg_zscore(mcc_degs)
mmu_degs_avgzscore <- mmu_mnn %>% get_deg_avg_zscore(mmu_degs)
pf_heatmap_rowscaled <- function(data, color = color_heat_avg, main = "Heatmap", color_row = color_cluster, ...){
annot_row <- data.frame(row.names = rownames(data),
Cluster = str_split_fixed(rownames(data), pattern = "_", n = 2)[, 1])
annot_row$Cluster %<>% factor(levels = unique(annot_row$Cluster))
pheatmap(mat = data,
cluster_rows = F, cluster_cols = F,
scale = "row", show_rownames = F,
annotation_row = annot_row,
annotation_colors = list(Cluster = color_row[levels(annot_row$Cluster)]),
color = colorRampPalette(color, interpolate = "spline", alpha = T)(99),
main = main,
...)
}
hsa_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Human data")
mcc_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Macaque data")
mmu_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Mouse data")
get_spec_data <- function(data){
data %>% as.data.frame() %>% rownames_to_column(var = "cluster") %>%
mutate(cluster = str_split(cluster, pattern = "_", simplify = T)[,1]) %>%
pivot_longer(cols = !cluster,
names_to = "stage_cluster",
values_to = "zscore") %>%
cbind(str_split(.$stage_cluster, pattern = ":", simplify = T) %>% set_colnames(c("stage", "cluster2"))) %>%
mutate(cluster_fill = ifelse(cluster == cluster2, cluster, "other_cluster")) %>%
mutate(stage_fill = ifelse(cluster == cluster2, stage %>% as.character(), "other_stage")) %>%
mutate(cluster = factor(cluster, levels = unique(cluster)),
stage_cluster = factor(stage_cluster, levels = unique(stage_cluster)),
stage = factor(stage, levels = unique(stage)),
cluster2 = factor(cluster2, levels = unique(cluster2)))
}
pf_spec_summary <- function(data, title = "Specification"){
get_spec_data(data) %>%
# violin plot
# ggplot(mapping = aes(stage_cluster, zscore)) +
# geom_violin(mapping = aes(fill = cluster_fill),
#             scale = "width", color = NA,
#             width = 0.8) +
# geom_boxplot(mapping = aes(fill = stage_fill),
#              width = 0.3,
#              outlier.shape = NA) +
# scale_fill_manual(values = c(color_cluster_hsa, color_stage_hsa, other_cluster = "grey80", other_stage = "white")) +
# facet_grid(cluster~.)
filter(cluster == cluster2) %>%
group_by(cluster, stage, stage_cluster) %>%
rstatix::get_summary_stats(zscore, type = c("mean_se"))  %>%
ggplot(mapping = aes(stage, mean)) +
ggforce::geom_link2(mapping = aes(group = cluster, color = stage, size = mean),
lineend = "round", n = 200) +
geom_errorbar(mapping = aes(ymin = mean-se, ymax = mean+se),
width = 0.5) +
geom_point(mapping = aes(fill = cluster),
shape = 21, size = 2) +
scale_fill_manual(values = c(color_cluster)) +
scale_size_continuous(range = c(0.5,3)) +
facet_grid(~cluster, scales = "free_x", space = "free") +
labs(y = "specification score", title = title)  +
theme(legend.position = "bottom", panel.spacing = unit(2, "pt"))
}
hsa_degs_avgzscore %>% pf_spec_summary(title = "Human Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_hsa)))
mcc_degs_avgzscore %>% pf_spec_summary(title = "Macaque Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_mcc)))
mmu_degs_avgzscore %>% pf_spec_summary(title = "Mouse Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_mmu)))
table(hsa_mnn$Stage, hsa_mnn$Cluster)
table(mcc_mnn$Stage, mcc_mnn$Cluster)
organotypic_clusters <- c("brEC", "luEC", "liEC", "kiEC", "adEC", "spEC", "aoEC")
panorgan_clusters <- c("arEC","unEC", "veEC", "lyEC")
hsa_degs_avgzscore <- hsa_mnn[,hsa_mnn$Cluster %in% organotypic_clusters] %>%
get_deg_avg_zscore(hsa_degs %>%
filter(cluster %in% organotypic_clusters))
mcc_degs_avgzscore <- mcc_mnn[, mcc_mnn$Cluster %in% organotypic_clusters] %>%
get_deg_avg_zscore(mcc_degs %>%
filter(cluster %in% organotypic_clusters))
mmu_degs_avgzscore <- mmu_mnn[, mmu_mnn$Cluster %in% organotypic_clusters] %>%
get_deg_avg_zscore(mmu_degs %>%
filter(cluster %in% organotypic_clusters))
pf_heatmap_rowscaled <- function(data, color = color_heat_avg, main = "Heatmap", color_row = color_cluster, ...){
annot_row <- data.frame(row.names = rownames(data),
Cluster = str_split_fixed(rownames(data), pattern = "_", n = 2)[, 1])
annot_row$Cluster %<>% factor(levels = unique(annot_row$Cluster))
pheatmap(mat = data,
cluster_rows = F, cluster_cols = F,
scale = "row", show_rownames = F,
annotation_row = annot_row,
annotation_colors = list(Cluster = color_row[levels(annot_row$Cluster)]),
color = colorRampPalette(color, interpolate = "spline", alpha = T)(99),
main = main,
...)
}
hsa_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Human data")
mcc_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Macaque data")
mmu_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Mouse data")
hsa_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Human data")
cbind(hsa_degs2, hsa_degs_avgzscore)
cbind(hsa_degs, hsa_degs_avgzscore) %>%
pivot_longer(cols = starts_with("week"),
names_to = "stage_cluster",
values_to = "zscore") %>%
mutate(stage_cluster = factor(stage_cluster, levels = levels(fct_cross(hsa_mnn$Stage, hsa_mnn$Cluster)))) %>%
cbind(str_split(.$stage_cluster, pattern = ":", simplify = T) %>% set_colnames(c("stage", "cluster2"))) %>%
mutate(cluster_fill = ifelse(cluster == cluster2, cluster2, "other_cluster")) %>%
mutate(stage_fill = ifelse(cluster == cluster2, stage, "other_stage")) %>%
mutate(stage = factor(stage, levels = levels(hsa_mnn$Stage)))
cbind(hsa_degs, hsa_degs_avgzscore)
cbind(hsa_degs %>% filter(cluster %in% organotypic_clusters), hsa_degs_avgzscore)
get_spec_data <- function(data){
data %>% as.data.frame() %>% rownames_to_column(var = "cluster") %>%
mutate(cluster = str_split(cluster, pattern = "_", simplify = T)[,1]) %>%
pivot_longer(cols = !cluster,
names_to = "stage_cluster",
values_to = "zscore") %>%
cbind(str_split(.$stage_cluster, pattern = ":", simplify = T) %>% set_colnames(c("stage", "cluster2"))) %>%
mutate(cluster_fill = ifelse(cluster == cluster2, cluster, "other_cluster")) %>%
mutate(stage_fill = ifelse(cluster == cluster2, stage %>% as.character(), "other_stage")) %>%
mutate(cluster = factor(cluster, levels = unique(cluster)),
stage_cluster = factor(stage_cluster, levels = unique(stage_cluster)),
stage = factor(stage, levels = unique(stage)),
cluster2 = factor(cluster2, levels = unique(cluster2)))
}
pf_spec_summary <- function(data, title = "Specification"){
get_spec_data(data) %>%
# violin plot
# ggplot(mapping = aes(stage_cluster, zscore)) +
# geom_violin(mapping = aes(fill = cluster_fill),
#             scale = "width", color = NA,
#             width = 0.8) +
# geom_boxplot(mapping = aes(fill = stage_fill),
#              width = 0.3,
#              outlier.shape = NA) +
# scale_fill_manual(values = c(color_cluster_hsa, color_stage_hsa, other_cluster = "grey80", other_stage = "white")) +
# facet_grid(cluster~.)
filter(cluster == cluster2) %>%
group_by(cluster, stage, stage_cluster) %>%
rstatix::get_summary_stats(zscore, type = c("mean_se"))  %>%
ggplot(mapping = aes(stage, mean)) +
ggforce::geom_link2(mapping = aes(group = cluster, color = stage, size = mean),
lineend = "round", n = 200) +
geom_errorbar(mapping = aes(ymin = mean-se, ymax = mean+se),
width = 0.5) +
geom_point(mapping = aes(fill = cluster),
shape = 21, size = 2) +
scale_fill_manual(values = c(color_cluster)) +
scale_size_continuous(range = c(0.5,3)) +
facet_grid(~cluster, scales = "free_x", space = "free") +
labs(y = "specification score", title = title)  +
theme(legend.position = "bottom", panel.spacing = unit(2, "pt"))
}
hsa_degs_avgzscore %>% get_spec_data() -> tmp
View(tmp)
get_pivot_data <- function(data){
data %>% as.data.frame() %>% rownames_to_column(var = "cluster") %>%
mutate(cluster = str_split(cluster, pattern = "_", simplify = T)[,1]) %>%
pivot_longer(cols = !cluster,
names_to = "stage_cluster",
values_to = "zscore") %>%
cbind(str_split(.$stage_cluster, pattern = ":", simplify = T) %>% set_colnames(c("stage", "cluster2"))) %>%
mutate(cluster_fill = ifelse(cluster == cluster2, cluster, "other_cluster")) %>%
mutate(stage_fill = ifelse(cluster == cluster2, stage %>% as.character(), "other_stage")) %>%
mutate(cluster = factor(cluster, levels = unique(cluster)),
stage_cluster = factor(stage_cluster, levels = unique(stage_cluster)),
stage = factor(stage, levels = unique(stage)),
cluster2 = factor(cluster2, levels = unique(cluster2)))
}
mmu_degs_avgzscore %>% get_pivot_data
mmu_degs_avgzscore %>% get_pivot_data %>%
ggplot(mapping = aes(stage_cluster, zscore)) +
geom_violin(mapping = aes(fill = cluster_fill),
scale = "width", color = NA,
width = 0.8) +
geom_boxplot(mapping = aes(fill = stage_fill),
width = 0.3,
outlier.shape = NA) +
scale_fill_manual(values = c(color_cluster_hsa, color_stage_hsa, other_cluster = "grey80", other_stage = "white")) +
facet_grid(cluster~.)
mmu_degs_avgzscore %>% get_pivot_data %>%
ggplot(mapping = aes(stage_cluster, zscore)) +
geom_violin(mapping = aes(fill = cluster_fill),
scale = "width", color = NA,
width = 0.8) +
geom_boxplot(mapping = aes(fill = stage_fill),
width = 0.3,
outlier.shape = NA) +
scale_fill_manual(values = c(color_cluster_hsa, color_stage_hsa, other_cluster = "grey80", other_stage = "white")) +
facet_grid(cluster~.)
pf_zscore_violin <- function(data){
data %>% get_pivot_data %>%
ggplot(mapping = aes(stage_cluster, zscore)) +
geom_violin(mapping = aes(fill = cluster_fill),
scale = "width", color = NA,
width = 0.8, show.legend = F) +
geom_boxplot(mapping = aes(fill = stage_fill),
width = 0.3,
outlier.shape = NA) +
scale_fill_manual(values = c(color_cluster_hsa, color_stage_hsa, other_cluster = "grey80", other_stage = "white")) +
facet_grid(cluster~.)
}
hsa_degs_avgzscore %>% pf_zscore_violin(main = "Zscore Violin of DEGs in Human data")
pf_zscore_violin <- function(data, title = NULL){
data %>% get_pivot_data %>%
ggplot(mapping = aes(stage_cluster, zscore)) +
geom_violin(mapping = aes(fill = cluster_fill),
scale = "width", color = NA,
width = 0.8, show.legend = F) +
geom_boxplot(mapping = aes(fill = stage_fill),
width = 0.3,
outlier.shape = NA) +
scale_fill_manual(values = c(color_cluster_hsa, color_stage_hsa, other_cluster = "grey80", other_stage = "white")) +
facet_grid(cluster~.) +
ggtitle(label = title)
}
hsa_degs_avgzscore %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Human data")
mcc_degs_avgzscore %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Macaque data")
mmu_degs_avgzscore %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Mouse data")
hsa_degs_avgzscore %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Human data")
mcc_degs_avgzscore %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Macaque data")
mmu_degs_avgzscore %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Mouse data")
hsa_degs_avgzscore_pivot <- hsa_degs_avgzscore %>% get_pivot_data()
mcc_degs_avgzscore_pivot <- mcc_degs_avgzscore %>% get_pivot_data()
mmu_degs_avgzscore_pivot <- mmu_degs_avgzscore %>% get_pivot_data()
pf_zscore_violin <- function(data, title = NULL){
data %>%
ggplot(mapping = aes(stage_cluster, zscore)) +
geom_violin(mapping = aes(fill = cluster_fill),
scale = "width", color = NA,
width = 0.8, show.legend = F) +
geom_boxplot(mapping = aes(fill = stage_fill),
width = 0.3,
outlier.shape = NA) +
scale_fill_manual(values = c(color_cluster_hsa, color_stage_hsa, other_cluster = "grey80", other_stage = "white")) +
facet_grid(cluster~.) +
ggtitle(label = title)
}
hsa_degs_avgzscore_pivot %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Human data")
mcc_degs_avgzscore_pivot %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Macaque data")
mmu_degs_avgzscore_pivot %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Mouse data")
pf_spec_summary <- function(data, title = "Specification"){
gdata %>%
filter(cluster == cluster2) %>%
group_by(cluster, stage, stage_cluster) %>%
rstatix::get_summary_stats(zscore, type = c("mean_se"))  %>%
ggplot(mapping = aes(stage, mean)) +
ggforce::geom_link2(mapping = aes(group = cluster, color = stage, size = mean),
lineend = "round", n = 200) +
geom_errorbar(mapping = aes(ymin = mean-se, ymax = mean+se),
width = 0.5) +
geom_point(mapping = aes(fill = cluster),
shape = 21, size = 2) +
scale_fill_manual(values = c(color_cluster)) +
scale_size_continuous(range = c(0.5,3)) +
facet_grid(~cluster, scales = "free_x", space = "free") +
labs(y = "specification score", title = title)  +
theme(legend.position = "bottom", panel.spacing = unit(2, "pt"))
}
hsa_degs_avgzscore_pivot %>% pf_spec_summary(title = "Human Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_hsa)))
pf_spec_summary <- function(data, title = "Specification"){
gdata %>%
filter(cluster == cluster2) %>%
group_by(cluster, stage, stage_cluster) %>%
rstatix::get_summary_stats(zscore, type = c("mean_se"))  %>%
ggplot(mapping = aes(stage, mean)) +
ggforce::geom_link2(mapping = aes(group = cluster, color = stage, size = mean),
lineend = "round", n = 200) +
geom_errorbar(mapping = aes(ymin = mean-se, ymax = mean+se),
width = 0.5) +
geom_point(mapping = aes(fill = cluster),
shape = 21, size = 2) +
scale_fill_manual(values = c(color_cluster)) +
scale_size_continuous(range = c(0.5,3)) +
facet_grid(~cluster, scales = "free_x", space = "free") +
labs(y = "specification score", title = title)  +
theme(legend.position = "bottom", panel.spacing = unit(2, "pt"))
}
hsa_degs_avgzscore_pivot %>% pf_spec_summary(title = "Human Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_hsa)))
pf_spec_summary <- function(data, title = "Specification"){
data %>%
filter(cluster == cluster2) %>%
group_by(cluster, stage, stage_cluster) %>%
rstatix::get_summary_stats(zscore, type = c("mean_se"))  %>%
ggplot(mapping = aes(stage, mean)) +
ggforce::geom_link2(mapping = aes(group = cluster, color = stage, size = mean),
lineend = "round", n = 200) +
geom_errorbar(mapping = aes(ymin = mean-se, ymax = mean+se),
width = 0.5) +
geom_point(mapping = aes(fill = cluster),
shape = 21, size = 2) +
scale_fill_manual(values = c(color_cluster)) +
scale_size_continuous(range = c(0.5,3)) +
facet_grid(~cluster, scales = "free_x", space = "free") +
labs(y = "specification score", title = title)  +
theme(legend.position = "bottom", panel.spacing = unit(2, "pt"))
}
hsa_degs_avgzscore_pivot %>% pf_spec_summary(title = "Human Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_hsa)))
View(hsa_degs_avgzscore_pivot)
hsa_degs_avgzscore_pivot %>% pf_spec_summary(title = "Human Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_hsa)))
mcc_degs_avgzscore_pivot %>% pf_spec_summary(title = "Macaque Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_mcc)))
mmu_degs_avgzscore_pivot %>% pf_spec_summary(title = "Mouse Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_mmu)))
hsa_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Human data")
mcc_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Macaque data")
mmu_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Mouse data")
mmu_degs_avgzscore <- mmu_mnn[, mmu_mnn$Cluster %in% organotypic_clusters] %>%
get_deg_avg_zscore(mmu_degs2 %>%
filter(cluster %in% organotypic_clusters))
mmu_degs_avgzscore_pivot <- mmu_degs_avgzscore %>% get_pivot_data()
mmu_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Mouse data")
hsa_degs_avgzscore <- hsa_mnn %>% get_deg_avg_zscore(hsa_degs2)
hsa_degs_avgzscore_pivot <- hsa_degs_avgzscore %>% get_pivot_data()
hsa_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Human data")
hsa_degs_avgzscore <- hsa_mnn %>% get_deg_avg_zscore(hsa_degs)
hsa_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Human data")
hsa_degs_avgzscore <- hsa_mnn %>% get_deg_avg_zscore(hsa_degs2)
hsa_degs_avgzscore %>% pf_heatmap_rowscaled(main = "Average Heatmap of DEGs with 2-fold change in Human data")
pf_spec_summary <- function(data, title = "Specification"){
data %>%
filter(cluster == cluster2) %>%
group_by(cluster, stage, stage_cluster) %>%
rstatix::get_summary_stats(zscore, type = c("mean_se"))  %>%
ggplot(mapping = aes(stage, mean)) +
ggforce::geom_link2(mapping = aes(group = cluster, color = stage, size = mean),
lineend = "round", n = 200) +
geom_errorbar(mapping = aes(ymin = mean-se, ymax = mean+se),
width = 0.5) +
geom_point(mapping = aes(fill = cluster),
shape = 21, size = 2) +
scale_fill_manual(values = c(color_cluster)) +
scale_size_continuous(range = c(0.5,3)) +
facet_grid(~cluster, scales = "free_x", space = "free") +
labs(y = "specification score", title = title)  +
ylim(c(0,NA)) +
theme(legend.position = "bottom", panel.spacing = unit(2, "pt"))
}
hsa_degs_avgzscore_pivot %>% pf_spec_summary(title = "Human Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_hsa)))
mcc_degs_avgzscore_pivot %>% pf_spec_summary(title = "Macaque Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_mcc)))
mmu_degs_avgzscore_pivot %>% pf_spec_summary(title = "Mouse Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_mmu)))
View(hsa_degs_avgzscore)
hsa_degs_avgzscore %<>% dplyr::select(`week 8:brEC`:`week 12:aoEC`)
View(hsa_degs_avgzscore_pivot)
View(hsa_degs_avgzscore)
View(hsa_degs_avgzscore_pivot)
hsa_degs_avgzscore_pivot <- hsa_degs_avgzscore %>% get_pivot_data() %>%
filter(cluster %in% organotypic_clusters & cluster2 %in% organotypic_clusters)
hsa_degs_avgzscore_pivot %>% pf_zscore_violin(title = "Zscore Violin of DEGs in Human data")
hsa_degs_avgzscore_pivot %>% pf_spec_summary(title = "Human Organ EC Specification") %>% add(scale_color_manual(values = c(color_stage_hsa)))
hsa_degs_avgzscore <- hsa_mnn %>% get_deg_avg_zscore(hsa_degs)
